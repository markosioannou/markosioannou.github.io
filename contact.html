---
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact • Markos Ioannou</title>

  <!-- Uses your existing site stylesheet -->
  <link rel="stylesheet" href="styles.css" />
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>

<body>
  <div class="shell">
    <header class="nav">
      <div class="nav-left">
        <div class="logo-circle">M</div>
        <div class="brand-text">
          <div class="brand-name">Markos Ioannou</div>
          <div class="brand-tag">Contact</div>
        </div>
      </div>

      <a class="pill-btn" href="index.html">← Back</a>
    </header>

    <main>
      <!-- LEFT: form panel -->
      <section class="panel">
        <div class="badge-row">
          <span class="badge-pill">Contact</span>
          Send me a message
        </div>

        <h1>Let’s talk</h1>
        <p class="subtitle">
          Fill in the form and I’ll get back to you. (No disposable email addresses.)
        </p>

        <form id="contact-form" class="contact-form" novalidate>
          <div class="field-row">
            <div class="field">
              <label for="name">Name</label>
              <input id="name" name="name" type="text" autocomplete="name" required />
            </div>

            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="email" required />
            </div>
          </div>

          <div class="field">
            <label for="subject">Subject</label>
            <input id="subject" name="subject" type="text" required />
          </div>

          <div class="field">
            <label for="message">Message</label>
            <textarea id="message" name="message" rows="6" required></textarea>
          </div>

          <!-- Turnstile (anti-bot) -->
          <div class="cf-turnstile"
               data-sitekey="0x4AAAAAACGPrYNWH3UJ-UKd"
               data-theme="dark"
               data-callback="onTurnstileOk"
               data-expired-callback="onTurnstileExpired">
          </div>
          
          <div class="form-actions">
            <button class="btn-main" id="submit-btn" type="submit">✉️ Send message</button>
            <span id="form-status" class="form-status" aria-live="polite"></span>
          </div>
        </form>

        <!-- Note:
             If you later add Turnstile, we’ll drop the widget right here above the button,
             and include its token in the payload. -->
      </section>

      <!-- RIGHT: links panel -->
      <aside class="panel-right">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Find me</div>
            <div class="card-kicker">Links</div>
          </div>

          <div class="card-link-row">
            <!-- Note: replace these with your real URLs -->
            <a class="card-link" href="https://www.linkedin.com/in/markosioannou" target="_blank" rel="noreferrer">LinkedIn</a>
            <a class="card-link" href="https://github.com/markosioannou" target="_blank" rel="noreferrer">GitHub</a>
            <a class="card-link" href="mailto:markos@markos-ioannou.com">Email</a>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Email</div>
            <div class="card-kicker">Direct</div>
          </div>
          <div style="color:#9ca3af; line-height:1.6;">
            markos@markos-ioannou.com
          </div>
        </div>
      </aside>
    </main>

  {% include footer.html %}
  </div>

<script>
  // Footer year
  document.getElementById("year").textContent = new Date().getFullYear();

  // ✅ Your Worker endpoint (change if you ever rename it)
  const WORKER_ENDPOINT = "https://contact-form.markosioannou.workers.dev";

  const form = document.getElementById("contact-form");
  const statusEl = document.getElementById("form-status");
  const submitBtn = document.getElementById("submit-btn");

  // Optional: clear status when user edits any field
  form.addEventListener("input", () => {
    statusEl.textContent = "";
  });

  // Small client-side disposable list (Worker also blocks with KV; this is just UX-fast)
  const DISPOSABLE = new Set([
    "mailinator.com",
    "yopmail.com",
    "tempmail.com",
    "10minutemail.com",
    "guerrillamail.com",
    "guerrillamail.net",
    "trashmail.com",
    "getnada.com",
    "maildrop.cc",
    "sharklasers.com",
  ]);

  function okEmailFormat(email) {
    const e = (email || "").trim().toLowerCase();
    if (e.length > 254) return false;
    if (e.includes("..")) return false;

    const at = e.indexOf("@");
    if (at <= 0 || at !== e.lastIndexOf("@")) return false;

    const domain = e.slice(at + 1);
    if (!domain.includes(".")) return false;

    const tld = domain.split(".").pop();
    if (!tld || tld.length < 2) return false;

    // basic domain label checks
    const labels = domain.split(".");
    for (const label of labels) {
      if (!label || label.length > 63) return false;
      if (!/^[a-z0-9-]+$/i.test(label)) return false;
      if (label.startsWith("-") || label.endsWith("-")) return false;
    }

    return true;
  }

  function isDisposable(email) {
    const domain = (email.split("@")[1] || "").toLowerCase();
    if (!domain) return true;
    if (DISPOSABLE.has(domain)) return true;

    // also block subdomains like foo.mailinator.com
    for (const bad of DISPOSABLE) {
      if (domain.endsWith("." + bad)) return true;
    }
    return false;
  }

  // Client-side (best-effort) rate limit: max 3 submits per 10 minutes
  const RL_KEY = "contact_rl";
  function canSubmitNow() {
    const now = Date.now();
    const windowMs = 10 * 60 * 1000;
    const max = 3;

    const raw = localStorage.getItem(RL_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const fresh = arr.filter((ts) => now - ts < windowMs);

    if (fresh.length >= max) {
      const minutes = Math.ceil((windowMs - (now - fresh[0])) / 60000);
      return { ok: false, minutes };
    }

    fresh.push(now);
    localStorage.setItem(RL_KEY, JSON.stringify(fresh));
    return { ok: true };
  }

  // ✅ Turnstile helpers
  function getTurnstileToken() {
    try {
      // This works for the common Turnstile setups
      if (window.turnstile && typeof window.turnstile.getResponse === "function") {
        return window.turnstile.getResponse();
      }
    } catch {}
    return "";
  }

  function resetTurnstileIfPresent() {
    try {
      if (window.turnstile && typeof window.turnstile.reset === "function") {
        window.turnstile.reset();
      }
    } catch {}
  }

  // Submit handler
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.textContent = "";

    // local rate limit (UX)
    const gate = canSubmitNow();
    if (!gate.ok) {
      statusEl.textContent = `Please wait ~${gate.minutes} min before trying again.`;
      resetTurnstileIfPresent();
      return;
    }

    const payload = {
      name: form.name.value.trim(),
      email: form.email.value.trim().toLowerCase(),
      subject: form.subject.value.trim(),
      message: form.message.value.trim(),
      // ✅ IMPORTANT: send token to Worker
      turnstileToken: getTurnstileToken(),
    };

    // Required checks (UX)
    if (!payload.name || !payload.email || !payload.subject || !payload.message) {
      statusEl.textContent = "Please fill in all fields.";
      resetTurnstileIfPresent();
      return;
    }

    if (!okEmailFormat(payload.email)) {
      statusEl.textContent = "Please enter a valid email address.";
      resetTurnstileIfPresent();
      return;
    }

    if (isDisposable(payload.email)) {
      statusEl.textContent = "Disposable email addresses are not allowed.";
      resetTurnstileIfPresent();
      return;
    }

    // Turnstile must be completed
    if (!payload.turnstileToken) {
      statusEl.textContent = "Please complete the anti-spam check.";
      resetTurnstileIfPresent();
      return;
    }

    submitBtn.disabled = true;
    statusEl.textContent = "Sending…";

    try {
      const res = await fetch(WORKER_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      // Worker returns JSON like: { ok:true } or { ok:false, message, field, code }
      const data = await res.json().catch(() => null);

      if (!res.ok || !data?.ok) {
        statusEl.textContent = data?.message || "Could not send. Please try again.";
        submitBtn.disabled = false;

        // ✅ KEY FIX: reset so user can fix fields + resubmit
        resetTurnstileIfPresent();
        return;
      }

      // success
      form.reset();
      statusEl.textContent = "Sent ✔ Thanks!";
      submitBtn.disabled = false;

      // ✅ Optional: reset after success too
      resetTurnstileIfPresent();
    } catch (err) {
      statusEl.textContent = "Network error. Please try again.";
      submitBtn.disabled = false;

      // ✅ reset on network errors too
      resetTurnstileIfPresent();
    }
  });
</script>
</body>
</html>
